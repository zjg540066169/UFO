---
title: "leaflet_map"
author: "J L"
date: "12/3/2019"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(viridis)
library(leaflet)

knitr::opts_chunk$set(
  # display the code in the code truck above its results in the final document
  echo = TRUE,
  # do not display any warning messages generated by the code
  warning = FALSE,
  # set the figure to be 8 x 6, and the proportion it takes to be 90%
  fig.width = 8,
  fig.height = 6, 
  out.width = "90%"
)

# setting a global options for continuous data color family and a different format to set discrete data to have a color family
options(
  ggplot2.countinuous.colour = "viridis",
  ggplot2.countinuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

# have a minimal theme and legends at the bottom
theme_set(theme_minimal() + theme(legend.position = "bottom"))
```

## read data

```{r}
ufo_data = read_csv("./data/tidied_data_final.csv", na = "")

ufo =
  ufo_data %>%  
  separate(date_time, into = c( "date","time"), sep = " " ) %>%
  separate( date, into = c("month","day","year"), sep = "/") %>% 
  mutate(a = longitude, longitude = latitude, latitude = a)
```


## percentage

calculate the percentage of UFO appearence frequency in one city among all US cities

```{r}
percentage_count = ufo %>% 
  filter(country == "USA") %>% 
  select(state, city, longitude, latitude) %>% 
  group_by(state, city, longitude, latitude) %>% 
  summarize(n = n()) %>% 
  arrange(n) 
count_all = percentage_count %>% 
  nrow() %>% 
  as.numeric()
percent_calc = function(num){
  count_num = percentage_count %>% 
    filter(n == num) %>% 
    nrow()
  percent = count_num / count_all
  percent
}
percent = percentage_count %>% 
  group_by(n) %>% 
  summarize(count = n()) %>% 
  mutate(percent = (count / count_all) * 100) %>% 
#  filter(n < 100) %>% 
  ggplot(aes(x = n, y = percent)) +
  geom_point() +
  geom_line() +
  labs(
    x = "UFO frequency",
    y = "percentage in all US cities",
    title = "Percentage of UFO Appearence Frequency among All US Cities"
  )

percent
```

From the plot, we can see that majority of the cities in which UFO appeared has UFO appearance frequency less than 25 times. Therefore, it would be reasonable to separate the frequency map plot at n = 25.

## map

For cities with UFO appearred less than 25 times:

```{r}
below25 = ufo %>% 
  filter(country == "USA") %>% 
  select(state, city, longitude, latitude) %>% 
  group_by(state, city, longitude, latitude) %>% 
  summarize(n = n()) %>% 
  filter(n <= 25) 

plot_below25 = leaflet(below25) %>% 
  addTiles() %>% 
  addCircleMarkers(
    radius = ~n/10,
    ~latitude,
    ~longitude,
    label = ~paste0(city, " ", state, ", ", n, " times seen UFO")
  )

plot_below25
```

In this plot, the size (radius) of circle markers corresponds to the frequency of UFO appearance in the city.



For cities with UFO appearred less than 25 times:

```{r}
above25 = ufo %>% 
  filter(country == "USA") %>% 
  select(state, city, longitude, latitude) %>% 
  group_by(state, city, longitude, latitude) %>% 
  summarize(n = n()) %>% 
  filter(n > 25) 
plot_above25 = leaflet(above25) %>% 
  addTiles() %>% 
  addCircleMarkers(
    radius = ~n/100,
    color = ~ifelse(n>300, "red", "navy"),
    ~latitude,
    ~longitude,
    label = ~paste0(city, " ", state, ", ", n, " times seen UFO")
  )
plot_above25
```

In this plot, the size (radius) of circle markers corresponds to the frequency of UFO appearance in the city. 7 cities with UFO appeared more than 300 times are marked in red, while others in color navy.
