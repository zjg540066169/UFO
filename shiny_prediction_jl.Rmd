---
title: "Predicting UFO"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(viridis)
library(leaflet)                 
```


```{r import, include=FALSE}
# data import and cleaning
ufo_data = read_csv("./data/tidied_data_final.csv", na = "")

ufo_usa =
  ufo_data %>%  
  separate(time, into = c("hour", "minute"), sep = ":") %>% 
  separate(date, into = c("month","day","year"), sep = "/") %>% 
  mutate(a = longitude, longitude = latitude, latitude = a) %>% 
  filter(country == "USA") %>% 
  select(latitude, longitude, state, city, year, month, day, hour, minute) 

ufo_frequncy = ufo_usa %>% 
  group_by(latitude, longitude, state, city) %>% 
  summarize(n = n())

ufo_usa = ufo_usa %>% 
  mutate(city_state = paste(city, state)) %>% 
  select(-city, -state)
```

Column {.sidebar}
-----------------------------------------------------------------------

```{r sidebar, echo=FALSE}
# set the year list for choices
years = c(1900:2100)
# selectInput widget for year
selectInput(
  "year_choice",
  label = h3("Choose year"),
  choices = years, selected = "2000")

# set the month list for choices
months = month.name
# selectInput widget for month
selectInput(
  "month_choice",
  label = h3("Choose month"),
  choices = months, selected = "January")

# set the day list for choices
days = c(1:31)
# selectInput widget for day
selectInput(
  "day_choice",
  label = h3("Choose day"),
  choices = days, selected = "1")

# set the hour list for choices
hours = ufo_usa %>% distinct(hour) %>% arrange(hour) %>% pull(hour) 
# selectInput widget for hour
selectInput(
  "hour_choice",
  label = h3("Choose hour"),
  choices = hours, selected = "00")

# set the minute list for choices
minutes = ufo_usa %>% distinct(minute) %>% arrange(minute) %>% pull(minute) 
# selectInput widget for hour
selectInput(
  "minute_choice",
  label = h3("Choose minute"),
  choices = minutes, selected = "00")

# set the city_state list for choices
city_states = ufo_usa %>% distinct(city_state) %>% pull(city_state)  
# selectInput widget (dropdown menu) for city_state
selectInput(
  "city_state_choice", 
  label = h3("Select city-state"),
  choices = city_states, selected = "Brooklyn NY")
```

Column 
-----------------------------------------------------------------------

### Predicting whether UFO will appear in the chosen place and time

```{r chartA, echo=FALSE}

ufo_data = read_csv(file = "./data/tidied_data_final.csv")



  # data tidy for prediction
ufo =
  ufo_data %>%  
  filter(country == "USA") %>% 
  separate(date, into = c("month","day","year"), sep = "/") %>% 
  separate(time, into = c("hour","minute"), sep = ":") %>% 
  select(year, month, day, hour, minute,state, city) %>%
  na.omit(ufo_data) %>% 
  mutate(add = paste(state, city)) %>% 
  select(-state, -city) 

# transform each levels in factors to new variables to form the input of SVM
factor_variable_cope = function(df){
    if (is.tibble(df)) {
      df = as.data.frame(df)
    }
    for (i in colnames(df[, sapply(df, is.factor)])) {
      for (level in unique(df[, i])) {
          df[paste(i, level, sep = "_")] = 
              as.integer(ifelse(df[, i] == level, 1, -1))
      }
    }
    df
  }


renderLeaflet({
  sample = tibble(add = input$city_state_choice, year = input$year_choice, month = input$month_choice, day = input$day_choice, hour = input$hour_choice, minute = input$minute_choice)

  
  
  
  
  svm_model = readRDS("SVM.rds")
  
  
  svm = 
    ufo %>% 
    rbind(sample) %>% 
    mutate(month = as.factor(month.name[as.numeric(month)]), year = as.numeric(year), hour = as.numeric(hour), minute = as.numeric(minute), day = as.numeric(day)) %>% 
    slice(nrow(.)) %>% 
    factor_variable_cope() %>% 
    select(-month, -add) %>% 
    mutate(year = as.integer(year), day = as.integer(day), hour = as.integer(hour), minute = as.integer(minute)) %>% 
    predict(svm_model, .)

  
  
  
  
  
  
  
  

  ufo_usa %>% 
    filter(city_state == input$city_state_choice) %>% 
    select(latitude, longitude, city_state) %>% 
    mutate(svm = svm_model) %>% 
    leaflet() %>% 
    addTiles() %>% 
    addCircleMarkers(
      radius = ~n/100,
      color = ~ifelse(svm[[1]] == TRUE, "red", "navy"),
      ~latitude,
      ~longitude
    )
})
```

