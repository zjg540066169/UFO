---
title: "UFO in USA"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
try(source("./dependencies.R"), silent = TRUE)
set.seed(1)
library(tidyverse)
library(leaflet)
library(dplyr)
library(ggplot2)
library(ggmap)
library(sf)
library(mapview)
library(rgdal)
library(htmltools)
library(viridis)
library(ggridges)


knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  fig.width = 8,
  fig.height = 6, 
  out.width = "90%"
)


options(
  ggplot2.countinuous.colour = "viridis",
  ggplot2.countinuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

theme_set(theme_minimal() + theme(legend.position = "bottom"))

```

# Visualization of UFO in USA

The goal of this part is to explore whether there is link between the shape of UFOs and their appearance in the U.S, as well as the association between shape of UFOs and their encounter length time.

# The Distribution of UFO Shape in the U.S

The light is the most frequent shape of UFO

<strong> Boxplot showing the distribution of the UFO Shape Observed in US </strong>

```{r boxplot_shape_distribution}
### Boxplot showing the distribution of the UFO Shape Observed in US
ufo_data = readr::read_csv("./data/tidied_data_final.csv")

ufo =
ufo_data %>%  
separate(date_time, into = c( "date","time"), sep = " " ) %>%
separate( date, into = c("month","day","year"), sep = "/") %>% 
  filter(country == "USA",year >= 1950) %>%
  group_by(state) %>%
  count(ufo_shape) %>%
  arrange(desc(n)) %>% 
  ungroup %>% 
  mutate(
  ufo_shape = factor(ufo_shape),
  ufo_shape = forcats::fct_reorder(ufo_shape, n)) %>%
  ggplot(aes(x = ufo_shape, y = n, group = ufo_shape)) +
  geom_boxplot(aes(color =ufo_shape)) +
  theme(axis.text.x = element_text(angle = 300)) +
  labs(
    title = "Boxplot showing distribution of the UFO Shape Observed in US ",
    x = "UFO Shape",
    y = "Number"
  )

ufo

```

Comment: 
According to this plot, we can see that the light UFO shape was sighted most often, and the changed shape was the least often according to their medium value. Some of the most common sighted UFO shapes are light, trianle, circle, unknown, other, and fireball, disk, and sphere. Some of the least common sighted UFO shapes are changed crescent, delta, flare, hezagon, pyramid and round. 


Explore whether the frequency of UFO shape changes with day and night
Generally, the UFOs are more likely to be observed during night. The shape of light is the most frequent shape during night


<strong> Times of Appearance for Each Shape of UFO (by day and night) </strong>

```{r day_night_shape}
ufo_day_night_shape =
ufo_data %>%  
separate(date_time, into = c( "date","time"), sep = " " ) %>%
separate(date, into = c("month","day","year"), sep = "/") %>%
separate(time, into = c("hour","minute"), sep = ":") %>% 
mutate(hour=recode(hour, "00"="24")) %>% 
filter(country == "USA") %>% 
mutate(year_1 = case_when(year >= 1950 ~ "true",
                          TRUE ~"false")) %>% 
filter(year_1 == "true") %>% 
select(-year_1) %>% 
mutate(hour = as.numeric(hour)) %>% 
mutate(night_day = case_when(18 <= hour & hour <= 24~ "night",
                             1 <= hour & hour <= 6 ~ "night",
                             TRUE ~ "day")) %>% 
group_by(ufo_shape, night_day) %>% 
summarize(count_shape = n()) %>% 
  ggplot(aes(x = ufo_shape, y = count_shape, group = night_day)) +
  geom_col(aes(fill = night_day), alpha = .75, position = position_dodge(1)) +
  scale_fill_manual(
    values = c("lightblue","lightpink"), 
    labels = c("day","night")
    ) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = "Times of Appearance for Each Shape of UFO (by day and night)", 
       y = "counts",
       x = "UFO Shape")
  
  ufo_day_night_shape
```


The spagetti plot confirms that UFOs are more likely to appear during night


<strong> Numbers of appearance of UFO in each hour by month </strong>
```{r spagetti_appearance_each_hour}
plot_us_month = ufo_data %>% 
  separate(date_time, into = c( "date","time"), sep = " " ) %>%
  separate( date, into = c("month","day","year"), sep = "/") %>% 
  filter(country == "USA",year >= 1950) %>%
  separate(time, into = c("hour", "minute"), sep = ":") %>% 
  mutate(hour = paste0(hour, ":00-", hour, ":59")) %>% 
  select(-minute) %>% 
  mutate(month = month.name[as.numeric(month)]) %>% 
  group_by(hour, ufo_shape) %>% 
  summarize(n = n()) %>% 
  ggplot(aes(x = hour, y = n, color = ufo_shape)) +
  geom_line(aes(group = ufo_shape)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(
    title = "Number of UFO in Each Hour by Month in US",
    x = "Hour",
    y = "Number"
  )

# display the plot
plot_us_month
```

Conclusion: 1):The most frequent shape of UFO is light; 
            2):The UFO is more likely to appear during night


# Shape vs. Encounter Length

The observations with low avg encounter length increases after 1990

<strong> avg encounter length among months across year </strong>
```{r heatmap_length_month_year}
## heatmap showing 
  ufo_heatmap = ufo_data %>% 
  separate(date_time, into = c( "date","time"), sep = " " ) %>%
  separate( date, into = c("month","day","year"), sep = "/") %>% 
  filter(country == "USA", year >= 1950, encounter_length <6000) %>%
  select(year, month, encounter_length) %>%
  mutate(year = as.numeric(year),
         month = as.numeric(month)) %>%
  group_by(year,month) %>%
  arrange(desc(month)) %>%
  mutate(
  ave_encountered_length = mean(encounter_length/60)) %>%
  select(-encounter_length) %>%
  ungroup() %>%
  mutate(month = month.name[as.numeric(month)]) %>%
  ggplot(aes(x = year, y = month)) +
  geom_tile(aes(fill = ave_encountered_length), colour = "white") +
  scale_fill_gradient(low = "lightyellow", high = "darkblue") +
  scale_x_continuous(name="Years", 
                     breaks = c(1950,    1955,1960,1965,1970,1975,1980,1985,1990,1995,2000,2005,2010,2015
                                ), limits= c (1950,2015)) +
  labs(
    title = "Average UFO Encounter Length Compared among Months Across Time in USA ",
    x = "Years",
    y = "Month"
  ) + 
  theme(axis.text.x = element_text(angle = 90)) +
  theme(plot.subtitle = element_text(hjust = 0.5))

ufo_heatmap
```


#shape vs. encounter length time 

<strong>The violin plot of encounter length for each shape of ufo </strong>

<strong>The bar chart of the median of encounter length time for each shape of UFO </strong>

```{r violin_plot_bar_chart}

# tidy data
length_shape_data = ufo_data %>% 
  mutate(ufo_shape = factor(ufo_shape),
         ufo_shape = forcats::fct_reorder(ufo_shape, encounter_length))

# violin plot 
length_shape_data %>% 
  ggplot(aes(x = ufo_shape, y = encounter_length, group = ufo_shape)) +
  geom_violin(aes(fill = ufo_shape), color = "cornsilk4", alpha = 0.4) +
  theme(axis.text.x = element_text(angle = 300)) +
  stat_summary(fun.y = median, geom = "point", color = "darksalmon", size = 3) +
  labs(title = "The Violin Plot of Encounter Length Time for Each Shape of UFO", 
       y = "Encounter Length of Time",
       x = "UFO Shape")

# function for removing outliers
#remove_outliers <- function(x, shape, na.rm = TRUE, ...) {
#  x = filter(x, ufo_shape == shape) %>% pull(encounter_length)
#  print(x)
#  qnt <- quantile(x, probs=c(.25, .75), na.rm = na.rm, ...)
#  H <- 1.5 * IQR(x, na.rm = na.rm)
#  y <- x
#  print(y)
#  y[x < (qnt[1] - H)] <- NA
#  y[x > (qnt[2] + H)] <- NA
#  y
#  }

#length_shape_data_no_outliers = length_shape_data %>% 
#  select(encounter_length, ufo_shape) %>% 
#  map_df(.x = unique(pull(ufo_shape)), ~remove_outliers(., .x, na.rm = FALSE))
  #remove_outliers(.,  unique(), na.rm = FALSE)

#length_shape_data_no_outliers



# violin plot without data for shape with outlier values
#length_shape_data %>% 
#  filter(encounter_length) %>% 
#  ggplot(aes(x = ufo_shape, y = encounter_length, group = ufo_shape)) +
#  geom_violin(aes(fill = ufo_shape), color = "cornsilk4", alpha = 0.4) +
#  theme(axis.text.x = element_text(angle = 300)) +
#  stat_summary(fun.y = median, geom = "point", color = "darksalmon", size = 3) +
#  labs(title = "The Violin Plot of Encounter Length Time for Each Shape of UFO (without outlier)", 
#       y = "Encounter Length of Time",
#       x = "UFO Shape")

# tidy data
median_length_shape_data = ufo_data %>% 
  group_by(ufo_shape) %>% 
  summarize(median_length = median(encounter_length), 
            count = n()) %>% 
  filter(count > 100) %>% 
  arrange(desc(median_length)) %>% 
  ungroup()

median_length_shape_data %>% 
  ggplot(aes(x = ufo_shape, y = median_length, fill = ufo_shape)) + 
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle = 300)) +
  labs(title = "The Bar Chart of Median of Encounter Length Time for Each Shape of UFO",
       y = "Median of Encounter Length Time",
       x = "UFO Shape")

```




<strong>The Median Length Time for Each Shape of UFO (by day and night) </strong>

Whether the relationship between shape and the length time would change by time

```{r length_day_night}
ufo_day_night_length =
ufo_data %>%  
separate(date_time, into = c( "date","time"), sep = " " ) %>%
separate(date, into = c("month","day","year"), sep = "/") %>%
separate(time, into = c("hour","minute"), sep = ":") %>% 
mutate(hour=recode(hour, "00"="24")) %>% 
filter(country == "USA") %>% 
mutate(year_1 = case_when(year >= 1950 ~ "true",
                          TRUE ~"false")) %>% 
filter(year_1 == "true") %>% 
select(-year_1) %>% 
mutate(hour = as.numeric(hour)) %>% 
mutate(night_day = case_when(18 <= hour & hour <= 24~ "night",
                             1 <= hour & hour <= 6 ~ "night",
                             TRUE ~ "day")) %>% 
  group_by(ufo_shape, night_day) %>% 
           summarize(median_length = median(encounter_length),
count = n()) %>% 
  filter(count > 100) %>% 
  ggplot(aes(x = ufo_shape, y = median_length, group = night_day)) +
  geom_col(aes(fill = night_day), alpha = .75, position = position_dodge(1)) +
  scale_fill_manual(
    values = c("lightblue","lightpink"), 
    labels = c("day","night")
    ) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = "The Median Length Time for Each Shape of UFO (by day and night)", 
       y = "median length",
       x = "UFO Shape")
  
  ufo_day_night_length
```

Conclusion:there is no association between encounter length time and UFO shape. 


# UFO Appearance in Each Month
```{r ufo_appearance_month}
ufo_month_counts_plot =
ufo_data %>%  
separate(date_time, into = c( "date","time"), sep = " " ) %>%
separate(date, into = c("month","day","year"), sep = "/") %>%
filter(country == "USA") %>% 
mutate(year_1 = case_when(year >= 1950 ~ "true",
                          TRUE ~"false")) %>% 
mutate(month = forcats::fct_relevel(month, c("1","2","3","4","5","6","7","8","9","10","11","12"))) %>% 
mutate(month = recode(month,"1"="Jan","2"="Feb","3"="Mar","4"="Apr","5"="May","6"="Jun","7"="Jul","8"="Aug","9"="Sep","10"="Oct","11"="Nov","12"="Dec")) %>% 
filter(year_1 == "true") %>% 
select(-year_1) %>% 
group_by(month) %>% 
summarize(count_month = n()) %>% 
  ggplot(aes(x = month, y = count_month)) +
  geom_col(aes(fill = month), alpha = .75, position = position_dodge(1)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = "The Plot of the Appearance UFO for Each Month", 
       y = "Counts of Appearance",
       x = "Month")
  
ufo_month_counts_plot
```
The frequency of UFO appearance is higher after June, and peaks at July. 